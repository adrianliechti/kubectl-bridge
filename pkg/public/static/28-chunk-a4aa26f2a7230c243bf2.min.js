(window.webpackJsonp=window.webpackJsonp||[]).push([[28],{4361:function(e,t,a){"use strict";a.r(t),a.d(t,"UnconnectedEnvironmentPage",(function(){return $})),a.d(t,"EnvironmentPage",(function(){return L}));var n=a(0),r=a(22),s=a(50),i=a(225),o=a(501),c=a(640),l=a(70),u=a(255),m=a(2328),d=a(16),p=a(7083),h=a(4434),v=a(113),b=a(363),E=a(116),g=a(1256),f=a(107),V=a(333),C=a(655),y=a(21),w=a(31),_=a(80),N=a(1939),S=a(966),j=a(19),O=a(18),M=a(7),D=a(13),R=a(8),I=a(5),F=a(10);const x=e=>n.createElement(I.c,Object.assign({loader:()=>Promise.resolve().then(a.bind(null,1949)).then(e=>e.NameValueEditor)},e)),P=e=>n.createElement(I.c,Object.assign({loader:()=>Promise.resolve().then(a.bind(null,1949)).then(e=>e.EnvFromEditor)},e)),T=(e={})=>{const t={};if(r.a(e.env)?t.env=[["","",0]]:t.env=s.a(e.env,(e,t)=>(r.a(e.value)&&r.a(e.valueFrom)&&(e.value="",delete e.valueFrom),e.ID=t,Object.values(e))),r.a(e.envFrom)){const e={name:"",key:""};t.envFrom=[["",{configMapSecretRef:e},0]]}else t.envFrom=s.a(e.envFrom,(e,t)=>(i.a(e,"prefix")||(e.prefix=""),e.ID=t,[e.prefix,o.a(e,["configMapRef","secretRef"]),e.ID]));return t},k=e=>{const t=c.a(e);if(l.a(t))return s.a(t,e=>{const{env:t,envFrom:a}=T(e);return[t,a]});const{env:a,envFrom:n}=T(t);return[[a,n]]},A=e=>u.a(e,(e,t,a)=>(e[t.name]=Object.assign(Object.assign({},t),{order:a}),e),{});class U{constructor(e,t,a){this.currentEnvVars={},this.state={allowed:!0},!r.a(e)&&arguments.length>1?this.setResultObject(e,t,a):this.setRawData(e)}setRawData(e){return this.rawEnvData=e,this.isContainerArray=l.a(e.containers),this.isCreate=r.a(e),this.hasInitContainers=!m.a(e.initContainers),this.isContainerArray||this.isCreate?(this.currentEnvVars.containers=k(e.containers),this.currentEnvVars.initContainers=k(e.initContainers)):this.currentEnvVars.buildObject=k(e),this}setResultObject(e,t,a){return t?this.setRawData(d.a(e,p.a(a))):this.setRawData(d.a(e,a))}getEnvVarByTypeAndIndex(e,t){return this.currentEnvVars[e][t]}setFormattedVars(e,t,a,n){return this.currentEnvVars[e][t][a]=n,this}getPatches(e){if(this.isContainerArray){const t=p.a(e).concat("initContainers"),a="add",n=this.currentEnvVars.containers.map((t,n)=>{const r=`/${e.join("/")}/${n}/env`,s=this._envVarsToNameVal(t[I.w.ENV]);return{path:r,op:a,value:s}}),r=this.currentEnvVars.containers.map((t,n)=>{const r=`/${e.join("/")}/${n}/envFrom`,s=this._envFromVarsToResourcePrefix(t[I.w.ENV_FROM]);return{path:r,op:a,value:s}});let s=h.a(n,r);if(this.hasInitContainers){const e=this.currentEnvVars.initContainers.map((e,n)=>{const r=`/${t.join("/")}/${n}/env`,s=this._envVarsToNameVal(e[I.w.ENV]);return{path:r,op:a,value:s}}),n=this.currentEnvVars.initContainers.map((e,n)=>{const r=`/${t.join("/")}/${n}/envFrom`,s=this._envFromVarsToResourcePrefix(e[I.w.ENV_FROM]);return{path:r,op:a,value:s}});s=h.a(s,e,n)}return s}return this.currentEnvVars.buildObject.map(t=>({path:`/${e.join("/")}/env`,op:"add",value:this._envVarsToNameVal(t[I.w.ENV])}))}dispatchNewEnvironmentVariables(){return this.isCreate?this._envVarsToNameVal(this.currentEnvVars.containers[0][I.w.ENV]):null}_envVarsToNameVal(e){const t=e=>v.a(e)?b.a(e).every(t):!e;return E.a(e,e=>{const a=e[I.U.Name],n=e[I.U.Value];return!t(a)||!t(n)}).map(e=>{const t=e[I.U.Name],a=e[I.U.Value];return v.a(a)?{name:t,valueFrom:a}:{name:t,value:a}})}_envFromVarsToResourcePrefix(e){return E.a(e,e=>!r.a(e[I.v.Resource])&&!e[I.v.Resource].configMapSecretRef).map(e=>g.a({prefix:e[I.v.Prefix]},e[I.v.Resource]))}}class $ extends I.bb{constructor(e){super(e),this.dismissSuccess=()=>{this.setState({success:null})},this.reload=this._reload.bind(this),this.saveChanges=this._saveChanges.bind(this),this.updateEnvVars=this._updateEnvVars.bind(this),this.selectContainer=this._selectContainer.bind(this);const t=new U(this.props.rawEnvData);this.state={currentEnvVars:t,success:null,containerIndex:0,containerType:t.isContainerArray||t.isCreate?"containers":"buildObject"}}componentDidMount(){this._checkEditAccess();const{addConfigMapSecret:e,readOnly:t,t:a}=this.props;if(!e||t){const e={},t={};return void this.setState({configMaps:e,secrets:t})}const n=d.a(this.props,"obj.metadata.namespace");Promise.all([Object(R.kb)(F.ConfigMapModel,null,n).catch(e=>{if(403!==e.response.status){const t=e.message||a("public~Could not load ConfigMaps.");this.setState({errorMessage:t})}return{configMaps:{}}}),Object(R.kb)(F.SecretModel,null,n).catch(e=>{if(403!==e.response.status){const t=e.message||a("public~Could not load Secrets.");this.setState({errorMessage:t})}return{secrets:{}}})]).then(([e,t])=>this.setState({configMaps:e,secrets:t}))}componentDidUpdate(e){const{obj:t,model:a,impersonate:n,readOnly:r,rawEnvData:s}=this.props,{dirty:i}=this.state;f.a(s,e.rawEnvData)||this.setState(Object.assign(Object.assign({},!i&&{currentEnvVars:new U(s)}),{stale:i})),d.a(e.obj,"metadata.uid")===d.a(t,"metadata.uid")&&d.a(e.model,"apiGroup")===d.a(a,"apiGroup")&&d.a(e.model,"path")===d.a(a,"path")&&e.impersonate===n&&e.readOnly===r||this._checkEditAccess()}_checkEditAccess(){const{obj:e,model:t,impersonate:a,readOnly:n}=this.props;if(n)return;if(r.a(e)||!t)return void this.setState({allowed:!0});const{name:s,namespace:i}=e.metadata,o={group:t.apiGroup,resource:t.plural,verb:"patch",name:s,namespace:i};Object(I.Fb)(o,a).then(e=>this.setState({allowed:e.status.allowed})).catch(e=>{console.warn("Error while check edit access for environment variables",e)})}_updateEnvVars(e,t=0,a=I.w.ENV){const{onChange:n}=this.props,{currentEnvVars:r,containerType:s}=this.state,i=c.a(r);i.setFormattedVars(s,t,a,e.nameValuePairs),this.setState({currentEnvVars:i,dirty:!0,success:null}),V.a(n)&&n(i.dispatchNewEnvironmentVariables())}_reload(){const{rawEnvData:e}=this.props;this.setState({currentEnvVars:new U(e),dirty:!1,errorMessage:null,stale:!1,success:null})}_selectContainer(e){const{rawEnvData:t}=this.props;let a=C.a(t.containers,{name:e});return-1!==a?this.setState({containerIndex:a,containerType:"containers"}):(a=C.a(t.initContainers,{name:e}),-1!==a?this.setState({containerIndex:a,containerType:"initContainers"}):void 0)}_saveChanges(e){const{envPath:t,obj:a,model:n,t:r}=this.props,{currentEnvVars:s}=this.state;e.preventDefault();const i=s.getPatches(t),o=Object(R.pb)(n,a,i);this.handlePromise(o).then(e=>{this.setState({currentEnvVars:new U(e,s.isContainerArray,t),dirty:!1,errorMessage:null,stale:!1,success:r("public~Successfully updated the environment variables.")})})}render(){const{errorMessage:e,success:t,inProgress:a,currentEnvVars:s,stale:i,configMaps:o,secrets:c,containerIndex:l,containerType:u,allowed:m}=this.state,{rawEnvData:p,obj:h,addConfigMapSecret:v,useLoadingInline:b,t:E}=this.props,g=this.props.readOnly||!m;if(!o||!s||!c)return b?n.createElement(I.T,null):n.createElement(I.S,null);const f=s.getEnvVarByTypeAndIndex(u,l),V=s.isContainerArray?n.createElement(I.j,{currentKey:p[u][l].name,containers:A(p.containers),initContainers:A(p.initContainers),onChange:this.selectContainer}):null,C=d.a(h.metadata,"ownerReferences",[]).map((e,t)=>n.createElement(I.hb,{key:t,kind:Object(R.Ib)(e),name:e.name,namespace:h.metadata.namespace,title:e.uid,inline:!0})),y=n.createElement(n.Fragment,null,g&&!r.a(C)&&n.createElement("div",{className:"co-toolbar__group co-toolbar__group--left"},n.createElement(_.a,{isInline:!0,className:"co-alert col-md-11 col-xs-10",variant:"info",title:E("public~Environment variables set from parent")},E("public~View environment for resource")," ",C.length>1?n.createElement(n.Fragment,null,"t('public~owners:') ",C):C)),s.isContainerArray&&n.createElement("div",{className:"co-toolbar__group co-toolbar__group--left"},n.createElement("div",{className:"co-toolbar__item"},E("containers"===u?"public~Container:":"public~Init container:")),n.createElement("div",{className:"co-toolbar__item"},V)),n.createElement("div",{className:O({"co-m-pane__body-group":!s.isCreate})},!s.isCreate&&n.createElement("h3",{className:"co-section-heading-tertiary"},E("public~Single values (env)"),!g&&n.createElement(I.B,null,n.createElement(M.Trans,{t:E,ns:"public"},"Define environment variables as key-value pairs to store configuration settings. You can enter text or add values from a ConfigMap or Secret. Drag and drop environment variables to change the order in which they are run. A variable can reference any other variables that come before it in the list, for example"," ",n.createElement("code",{className:"co-code"},"FULLDOMAIN = $(SUBDOMAIN).example.com"),"."))),n.createElement(x,{nameValueId:l,nameValuePairs:f[I.w.ENV],updateParentData:this.updateEnvVars,nameString:E("public~Name"),readOnly:g,allowSorting:!0,configMaps:o,secrets:c,addConfigMapSecret:v})),s.isContainerArray&&n.createElement("div",{className:"co-m-pane__body-group environment-buttons"},n.createElement("h3",{className:"co-section-heading-tertiary"},E("public~All values from existing ConfigMaps or Secrets (envFrom)"),!g&&n.createElement(I.B,null,n.createElement(n.Fragment,null,E("public~Add new values by referencing an existing ConfigMap or Secret. Drag and drop environment variables within this section to change the order in which they are run."),n.createElement("br",null),n.createElement("strong",null,E("public~Note:"))," ",E("public~If identical values exist in both lists, the single value in the list above will take precedence.")))),n.createElement(P,{nameValueId:l,nameValuePairs:f[I.w.ENV_FROM],updateParentData:this.updateEnvVars,readOnly:g,configMaps:o,secrets:c})));return n.createElement("div",{className:O({"co-m-pane__body":!s.isCreate})},y,!s.isCreate&&n.createElement("div",{className:"co-m-pane__body-group"},n.createElement("div",{className:"pf-v5-c-form environment-buttons"},e&&n.createElement(_.a,{isInline:!0,className:"co-alert",variant:"danger",title:e}),i&&n.createElement(_.a,{isInline:!0,className:"co-alert",variant:"info",title:E("public~The information on this page is no longer current.")},E("public~Click Reload to update and lose edits, or Save Changes to overwrite.")),t&&n.createElement(_.a,{isInline:!0,className:"co-alert",variant:"success",title:t,actionClose:n.createElement(N.a,{onClose:this.dismissSuccess})}),!g&&n.createElement(S.a,null,n.createElement(j.a,{isDisabled:a,type:"submit",variant:"primary",onClick:this.saveChanges,"data-test":"environment-save"},E("public~Save")),n.createElement(j.a,{isDisabled:a,type:"button",variant:"secondary",onClick:this.reload},E("public~Reload"))))))}}const B=Object(w.connect)((e,{obj:t})=>({model:e.k8s.getIn(["RESOURCES","models",Object(R.Db)(t)])||e.k8s.getIn(["RESOURCES","models",t.kind]),impersonate:Object(D.I)(e)}))($),L=Object(M.withTranslation)()(B);L.propTypes={obj:y.object,rawEnvData:y.oneOfType([y.object,y.array]),envPath:y.array.isRequired,readOnly:y.bool.isRequired,onChange:y.func,addConfigMapSecret:y.bool,useLoadingInline:y.bool},L.defaultProps={obj:{},rawEnvData:{},addConfigMapSecret:!0}}}]);
//# sourceMappingURL=28-chunk-a4aa26f2a7230c243bf2.min.js.map